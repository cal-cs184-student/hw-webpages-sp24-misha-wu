<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>CS184 Ray-tracing</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
    margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-uiBlue { background-color: rgba(35, 131, 226, .07); }
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }
.select-value-color-pageGlass { background-color: undefined; }
.select-value-color-washGlass { background-color: undefined; }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="870d1e1f-7aaf-4fb0-ad21-82100adbddda" class="page sans"><header><h1 class="page-title">CS184 <strong>Ray-tracing</strong></h1><p class="page-description"></p></header><div class="page-body"><blockquote id="8e0cfc8a-1449-4526-8145-05d46ce7e910" class="">Code, Writeup: Michelle Wu<br/>Source: CS184<br/>Repo: <br/><a href="https://github.com/cal-cs184-student/hw3-pathtracer-sp24-39">https://github.com/cal-cs184-student/hw3-pathtracer-sp24-39</a></blockquote><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="19e74b28-9e7c-4ba5-8ac0-90c8d307032f"><div style="font-size:1.5em"><span class="icon">💡</span></div><div style="width:100%">In this assignment, we explore different methods of rendering <strong>lighting </strong>in 3D scenes. To do this, we create a <mark class="highlight-blue"><strong>physical-based ray tracer</strong></mark><strong>, </strong>or a ray-tracer that illuminates a scene by simulating light rays through the camera. <br/><br/>To do so, we work on many components. We first update our rasterizer to take into account luminance and sample multiple times within a pixel. Finally, we implement direct and indirect lighting to properly render out elements with lighting equations.<br/><br/>To optimize the above algorithms, we implemented BVH to better organize the objects in our scene, allowing us to figure out faster if and where a ray intersects the scene. We also implemented adaptive sampling, or adjusting the sampling rate depending on variance, to improve sampling times and decrease wasteful computation.<br/></div></figure><blockquote id="87284c63-50bf-4e24-8f4e-bdcaefe5fba3" class=""><em>Note! Applicable to parts </em><strong><em>1 &amp; 2</em></strong><em>.<br/><br/></em>All <code>../dae/sky</code> files will be rendered at <code>480 x 360</code> pixels. All other files will be rendered at <code>800 x 600</code> pixels to avoid cutoff.</blockquote><h2 id="1807d841-5c60-4758-9e93-e04729a2b6ec" class="">Part 1: Ray Generation and Scene Intersection</h2><h3 id="35711281-65fa-4522-a157-9e6ce813639b" class=""><strong>Path tracing</strong></h3><p id="25f67f42-65ad-43d8-910a-3c0f8a5c0c29" class="">We first implement ray generation and primitive intersections to enable basic shading.</p><p id="f9ed91c2-ad2b-4ab4-b43d-3e9b7631f28c" class="">Because our image is pixel-based, we intuitively wish to figure out — “sample” — the coloring of each pixel. At a high level, we wish to calculate the average of the colors of rays that originate at <code>camera_pos</code> and extend through the <code>(x, y)</code> pixel. Because a pixel is a unit area, the specific “hit point” is also randomized within the contained coordinate; this allows us to obtain better results at higher pixel sampling rates.</p><p id="d98aafa4-eaff-435f-b5ac-894359fe30e6" class="">We generate this ray by sampling a point within the <code>(x&#x27;, y&#x27;)</code> pixel in <em>image (”raster”) space,</em> before normalizing to the range <code>[0, 1]</code>.  We then convert to <em>camera space, </em>or coordinates with the origin <code>(0, 0)</code> being representative of the camera’s position, by transforming with the sensor settings <code>hFov</code> and <code>vFov</code> .</p><p id="45411989-805b-42ad-b845-2b4c0716bf36" class="">Here, we then set the ray settings <code>min_t</code>  and <code>max_t</code> for future parts, before normalizing and transforming into <strong>world space</strong>, or the 3D space of the objects in the scene.</p><p id="fece3863-d811-42d0-ac98-fa44d36dfd72" class="">
</p><figure id="38eae73f-5ba3-4866-899c-d3daf8958911" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/Untitled.png"><img style="width:479px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/Untitled.png"/></a></figure><p id="05539940-1a3e-425e-a040-ee8f8f364a2c" class="">We can now render colors properly; however, we do not properly render primitive objects yet. Two specific primitives we implement are <code>triangles</code>  and <code>spheres</code> ; after this, we can properly render scenes composed of the above objects.</p><h3 id="08e7fd2b-11a4-46a0-98e8-ce51cd4518bd" class=""><strong>Intersections</strong></h3><p id="2259487f-2b77-4870-847c-5ca33febc40f" class="">We implement ray-triangle, at a high level, by ensuring ray-plane intersection, then ensuring the barycentric coordinates of the intersection point are within the triangle. Ray-plane intersection is valid when there is a solution to <code>p = r(t)</code>, where <code>p</code> is the plane equation and <code>r(t) = o + td</code> is the ray equation. Similarly, a point falls within a triangle if it’s barycentric coordinates <code>alpha, beta, gamma</code> sum to 1 and are each within <code>[0, 1]</code>.</p><p id="19abf2ea-1db3-43b0-8ca8-99cdc0ab907a" class="">In implementation, we actually use the Möller–Trumbore intersection algorithm to optimize, which simplifies the above steps into a matrix multiplication problem.</p><p id="25d11d2b-7185-445e-8d7b-65c5d7332ed8" class="">Similarly, we implement ray-sphere intersection by solving for the intersection between the ray equation and the sphere equation — <code>(p-c)^2 - R^2 = 0</code> .</p><p id="235706a0-9fa0-4594-86ee-81c331c89163" class="">Finally, we update the intersection with valid normals — calculated for <code>sphere intersection</code>, interpolated with barycentric coordinates for <code>triangle intersection</code> — and auxiliary shading information to enable our renderer to draw such scenes.</p><p id="73391466-d715-4c73-8f64-a22956280837" class="">Some results of basic scenes are as follows</p><div id="607d52bb-7907-437b-a42f-86e0bd2ff7e0" class="column-list"><div id="dd8f68ee-4977-4625-8a64-3b2699c6a2cd" style="width:50%" class="column"><figure id="15092137-0887-4992-b306-8b2a6e41bc38" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/cube.png"><img style="width:800px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/cube.png"/></a><figcaption><code>cube.png<br/><br/></code>render command:  <code>./pathtracer -r 800 600 -f cube.png ../dae/simple/cube.dae</code></figcaption></figure></div><div id="8e109933-d450-4598-9f09-5834df446c4f" style="width:50%" class="column"><figure id="53d581ad-70cb-44d3-ace4-6b05a5c8a054" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/banana.png"><img style="width:708px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/banana.png"/></a><figcaption><code>banana.png<br/><br/></code>render command:  <code>./pathtracer -r 800 600 -f banana.png ../dae/simple/banana.dae</code></figcaption></figure></div></div><figure id="b63144f0-df5d-4099-96fc-96247c34fd5d" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/cow.png"><img style="width:708px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/cow.png"/></a><figcaption><code>cow.png<br/><br/></code>render command:  <code>./pathtracer -r 800 600 -f cow.png ../dae/simple/cow.dae</code></figcaption></figure><h2 id="ed4ca481-39a9-49c7-9b3f-66e8a4069254" class="">Part 2: BVH</h2><p id="7e5c15cc-c33e-4406-837f-d74afd8394db" class="">Although we can now render intersected objects correctly, even the simplest scene takes multiple seconds — far too long if we ever wish to render complex objects or incorporate physical lighting. To speed things up, we look into optimizing the data structures behind our object organization.</p><p id="89ee3025-306e-4332-9054-8164247e0d27" class="">Specifically, we create a Bounding Volume Hierarchy (BVH). Currently, our rays test every object in the scene for intersection</p><p id="c5547794-5819-44fd-b482-4acac9605352" class="">This is a tree-like collection that groups scene objects into sets; each set is encapsulated by it’s own large “bounding box”. Thus, a ray can eliminate groups of objects at a time by checking for intersection of each <strong>bounding box</strong>, rather than each individual primitive.</p><p id="356149ed-7c02-4d37-83e7-3fde4624d200" class="">To construct the tree, we recursively evaluate the available primitives. If there are less primitives than <code>max_leaf_size</code>, we directly group them in a leaf node on our BVH tree; when accessed, we just iterate through the primitives. Else, we split the list by the <mark class="highlight-blue"><strong>longest axis</strong></mark><strong> — </strong>this is calculated via the <code>extent</code>. The axis whose <code>extent[axis]</code> is largest gets split in half via splitting the sorted (by centroid) list. The first half of the list becomes the <code>left</code> node, while the right half becomes the <code>right</code> node. This algorithm is recursively run until all primitives end up in a leaf node.</p><blockquote id="8267bf64-a927-4254-885a-807069512f78" class="">Note that BVH algorithms with great overlap will not see as much improvement, because a ray will take much more calls to fail a bounding box test. Splitting on the longest axis — our heuristic — takes around 50 seconds to render <code>../dae/sky/dragon.dae</code> , while splitting on the x axis (chosen arbitrarily) takes around 110 seconds to render. Thus, the splitting algorithm can also greatly affect runtimes as meshes get more complicated.</blockquote><h3 id="77f0bda9-d15a-4813-b938-e9b8ed3eff88" class=""><strong>Below are some examples of BVH vs non-BVH metrics.</strong></h3><figure id="fb1e3c2a-97b4-4470-bcba-59792e298239" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/teapot.png"><img style="width:708px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/teapot.png"/></a><figcaption><code>teapot.png<br/><br/></code>render setting: <code>./pathtracer -r 800 600 -f teapot.png ../dae/meshedit/teapot.dae</code></figcaption></figure><p id="552c0985-020d-4670-b69e-d298d2525012" class="">
</p><table id="97ba2953-e1bc-4437-b4da-0232f3c1f9e1" class="simple-table"><thead class="simple-table-header"><tr id="1d0d818f-4424-435e-a9ec-8a849973bc83"><th id="p?Tc" class="simple-table-header-color simple-table-header" style="width:230px"><strong>teapot.dae</strong></th><th id="vbm@" class="simple-table-header-color simple-table-header" style="width:230px">with BVH</th><th id="}sfE" class="simple-table-header-color simple-table-header" style="width:230px">no BVH (one leaf node)</th></tr></thead><tbody><tr id="b9c8ae64-f8cf-41fc-8b5e-8f06c132313c"><th id="p?Tc" class="simple-table-header-color simple-table-header" style="width:230px">BVH creation time (s)</th><td id="vbm@" class="" style="width:230px">0.0019 sec</td><td id="}sfE" class="" style="width:230px">0.0 sec</td></tr><tr id="d708cb8a-52a0-424f-8a6c-dc8dd673957f"><th id="p?Tc" class="simple-table-header-color simple-table-header" style="width:230px">Render time (s)</th><td id="vbm@" class="" style="width:230px">0.2620 sec</td><td id="}sfE" class="" style="width:230px">14.5540 sec</td></tr><tr id="1f4029bd-58e3-4d6b-9769-d58a6a220851"><th id="p?Tc" class="simple-table-header-color simple-table-header" style="width:230px">Average # of intersection tests</th><td id="vbm@" class="" style="width:230px">19.747869</td><td id="}sfE" class="" style="width:230px">2464.00</td></tr></tbody></table><figure id="ff42d0a3-1be1-4d19-b7cf-2d3a611c171e" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/banana%201.png"><img style="width:708px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/banana%201.png"/></a><figcaption><code>banana.png<br/><br/></code>render setting: <code>./pathtracer -r 800 600 -f banana.png ../dae/keenan/banana.dae</code></figcaption></figure><table id="1bd707ac-f234-40c0-8d81-99691271b9ae" class="simple-table"><thead class="simple-table-header"><tr id="0e004643-4aaf-4a73-8687-b95e6cfdac2c"><th id="p?Tc" class="simple-table-header-color simple-table-header" style="width:230px"><strong>banana.dae</strong></th><th id="vbm@" class="simple-table-header-color simple-table-header" style="width:230px">with BVH</th><th id="}sfE" class="simple-table-header-color simple-table-header" style="width:230px">no BVH (one leaf node)</th></tr></thead><tbody><tr id="49d87814-de75-47a6-b249-d820ebdabb2b"><th id="p?Tc" class="simple-table-header-color simple-table-header" style="width:230px">BVH creation time (s)</th><td id="vbm@" class="" style="width:230px">0.0005 sec</td><td id="}sfE" class="" style="width:230px">0.0 sec</td></tr><tr id="8f40d202-dc26-4789-907a-617fbd3c4f73"><th id="p?Tc" class="simple-table-header-color simple-table-header" style="width:230px">Render time (s)</th><td id="vbm@" class="" style="width:230px">0.0017 sec</td><td id="}sfE" class="" style="width:230px">15.8243 sec</td></tr><tr id="6e896664-3016-423d-94a5-a8f29cbd5b95"><th id="p?Tc" class="simple-table-header-color simple-table-header" style="width:230px">Average # of intersection tests</th><td id="vbm@" class="" style="width:230px">8.486608</td><td id="}sfE" class="" style="width:230px">2458.00</td></tr></tbody></table><p id="b9ce3076-81d5-4a42-ba8d-b508a42604f4" class="">We see that the above renders take more time constructing the BVH, but less time rendering. This makes sense; we recursively create multiple encapsulating nodes for our data structures. However, the BVH greatly improves runtime by <strong>drastically reducing the amount of intersection tests.</strong> This allows renders to speed up <em>much </em>more; recall that our naive object organization makes every ray iterate through every object! Thus, BVH allows us to cut to <code>O(log N)</code> runtimes from <code>O(n)</code> by allowing us to quickly eliminate non-intersecting nodes. It’s also important to note that our BVH splitting algorithm plays a factor too. </p><h3 id="ed46197d-be59-43ab-9a99-9166487d2888" class=""><strong>Some more complicated renders and metrics:</strong></h3><div id="90796bc0-a574-4f63-b672-672086c4c5e0" class="column-list"><div id="71960199-37f4-4b5e-a155-2256dd3f758f" style="width:50%" class="column"><figure id="91b2b8d8-66b2-4c10-aaea-bf3d0c216d97" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/cbdragon.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/cbdragon.png"/></a><figcaption><code><strong>cbdragon.png</strong></code><strong><br/><br/></strong>render setting: <code>./pathtracer -r 480 360 -f cbdragon.png ../dae/sky/CBdragon.dae</code><br/>time to render: 0.3501 sec<br/># of primitives: 100012<br/>avg # intersection tests / ray: 23.364256<br/></figcaption></figure></div><div id="eba194cb-ac3a-40ef-a961-06a8f84a59dc" style="width:50%" class="column"><figure id="f678afdc-7cea-4c10-aea3-8db8366702a0" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/maxplanck.png"><img style="width:708px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/maxplanck.png"/></a><figcaption><code><strong>maxplanck.png</strong></code><strong><br/><br/></strong>render setting: <code>./pathtracer -r 800 600 -f maxplanck.png ../dae/meshedit/maxplanck.dae</code> <br/>time to render: 1.0263 sec<br/># of primitives: 50801<br/>avg # intersection tests / ray: 80.584744<br/></figcaption></figure></div></div><h3 id="6a9c7328-32e2-4f25-9404-b1a80736d88f" class="">As well as some scenes at higher settings.</h3><div id="b570cb70-bca9-43e1-bf3e-e81c030023fa" class="column-list"><div id="2c443099-92f1-4a76-8705-3c5938218ba6" style="width:50%" class="column"><figure id="469c3e17-7f67-4544-9d24-2c62a472ee3b" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/banana_hq.png"><img style="width:800px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/banana_hq.png"/></a><figcaption><code><strong>banana_hq.png</strong></code><strong><br/><br/></strong>render setting: <code>./pathtracer -t 8 -s 1024 -l 4 -r 800 600 ../dae/keenan/banana.dae</code><br/>time to render: 56.6755 sec<br/># of primitives: 2458<br/>avg # intersection tests / ray: 7.654459<br/></figcaption></figure></div><div id="9ca68351-a330-4b2a-8172-fcb37e4e8b92" style="width:50%" class="column"><figure id="681fdc79-6c77-4ebc-bb67-5ee2b016fb69" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/dragon_hq.png"><img style="width:800px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/dragon_hq.png"/></a><figcaption><code><strong>dragon_hq.png</strong></code><strong><br/><br/></strong>render setting: <code>./pathtracer -t 8 -s 1024 -l 4 -r 800 600 ../dae/sky/dragon.dae</code><br/>time to render: 133.0801 sec<br/># of primitives: 105120<br/>avg # intersection tests / ray: 6.273387<br/></figcaption></figure></div></div><h2 id="b704b1db-2895-476d-adf8-4c8d7e7860ed" class=""><strong>Part 3: Direct Illumination</strong></h2><p id="2bd90da5-496c-456b-8c6f-fbf7fb77fc30" class="">In this section, we implement direct illumination. Direct illumination is the illumination of objects that are directly “touched” by the lights — think how ones hair lights up with overhead lighting.</p><p id="6a7f90f1-1953-4394-9c94-e5c018e7662f" class="">At a high level, we follow the ray launched from the camera; on intersecting an object in the scene, we generate rays in “random” new directions, performing Monte Carlo sampling. If a secondary ray hits a light, we know the origin of that ray — the intersection point — is illuminated by the light; the final luminance can be calculated by averaging out the samples.</p><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="0af9710f-41be-4711-9390-f48838d63bcd"><div style="font-size:1.5em"><span class="icon">💭</span></div><div style="width:100%"><strong>Importance Sampling vs Hemisphere Sampling<br/><br/></strong>As mentioned earlier, we “randomly” shoot rays to estimate the actual amount of light hitting the intersection point. <br/><br/>One method to do this is via <br/><strong>hemisphere sampling </strong>— we randomize a direction off the hemisphere and shoot it to check for intersection with lights; else, this point is unilluminated. This method is intuitive, but costly — only a small portion of scenes are  lights, and it takes many <em>many</em> samples for this sampling method to converge.<br/><br/>Thus, we introduce <br/><strong>importance sampling</strong>, or where we only sample from the available lights and normalize our values. Specifically, for each light, we sample either <code>ns_aa</code> times for area lights, or <code>1</code> time for point lights. Then, our averaged sample contributes <code>1/num_lights</code> into our final luminance. This allows us to sample from only useful areas that may impact our image, resulting in better results with less noise.<br/><br/><br/><strong>Comparison between hemisphere and importance sampling:<br/><br/></strong>It is evident that there is more noise in <strong>hemisphere sampling</strong>. This is understandable; for the same amount of random rays projected, only a small portion of them will actually carry information, because there are a small amount of lights in the scene. In comparison, every ray projected via importance sampling provides information, allowing noise-free results<br/><br/>Below is a comparison. Both are rendered with the following settings:<br/><p id="c4afac6c-9513-4436-90ad-e05d01057348" class=""><code>./pathtracer -t 8 -s 64 -l 32 -m 6 -r 480 36</code></p><figure id="146e5539-113b-4d5c-a7fa-9c146fc98db2" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/CBbunny_H_64_32.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/CBbunny_H_64_32.png"/></a><figcaption>hemisphere sampling; <code>bunny_64_32_hemi.png</code></figcaption></figure><figure id="bc9ac15c-bd3e-4bf6-8f36-787c9d320561" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_64_32_imp.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_64_32_imp.png"/></a><figcaption>importance sampling; <code>bunny_64_32_imp.png</code> </figcaption></figure><p id="635e2f15-2522-42e0-8c33-0944b80d2935" class="">Notice how, although the colorations are similar, importance sampling is <em>much </em>cleaner and blurred. Hemisphere sampling still has a grainy look.</p></div></figure><p id="7a291a29-616a-45d1-8352-837340e2b387" class="">
</p><p id="b8b2062e-fde2-4bd0-93b7-6f01a51675cc" class="">Here are the results when using importance sampling at different <code>light_rays</code> settings.</p><div id="ff5b54a1-c958-4ffd-8a95-b6ecaee33bd7" class="column-list"><div id="6a94593f-287f-4600-b523-12d34ad41624" style="width:50%" class="column"><figure id="040cc736-f585-4d09-a7b5-621f93fccd29" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_pt3_1.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_pt3_1.png"/></a><figcaption><code>-l 1</code> ; <code>bunny_pt3_1.png</code></figcaption></figure></div><div id="366415a8-4bdb-4f26-a918-deb034473e57" style="width:50%" class="column"><figure id="a61d2262-4876-416d-a9bf-e7705c864ef2" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_pt3_4.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_pt3_4.png"/></a><figcaption><code>-l 4</code> ; <code>bunny_pt3_4.png</code></figcaption></figure></div></div><div id="3f3e7930-297d-4a3b-bddc-774d8a199157" class="column-list"><div id="3f1dae7d-6eae-41b5-bb8a-996a299cab58" style="width:50%" class="column"><figure id="9f2b36ef-cab1-4bef-94cb-e00378e0ff6a" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_pt3_16.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_pt3_16.png"/></a><figcaption><code>-l 16</code> ; <code>bunny_pt3_16.png</code></figcaption></figure></div><div id="bcdbcea3-251b-4510-8201-8e18267dd381" style="width:50%" class="column"><figure id="a9d47dfa-441d-4188-91c2-b33234980ef7" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_pt3_64.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_pt3_64.png"/></a><figcaption><code>-l 64</code> ; <code>bunny_pt3_64.png</code></figcaption></figure></div></div><p id="1b664774-6d6c-46b8-be82-8e22d4cdf607" class="">Evidently, as <code>light_rays</code> goes up, noise is reduced. The results are especially drastic when inspecting the softer shadows under the bunny — shadows appear as discrete dots when <code>l=1</code>, because the ray generated might cross the rabbit and not hit the area light. However, when <code>l=16</code>, the <em>portion </em>of rays that hits the light source becomes closer to the true value, resulting in properly blurred shadows.</p><h2 id="b33889f6-6fc5-4aaa-a3af-1327a1ce6f26" class=""><strong>Part 4: Global Illumination</strong></h2><p id="4309cad4-a347-4002-b804-5f50d44e744d" class="">In this section, we focus on introducing indirect lighting into our equations, implementing global illumination.</p><p id="6ae820b6-c74a-4671-a45c-25dd5d7dc1cd" class="">We implement indirect lighting similar, by calculating the direct lighting at the <em>current bounce </em>and the recursive indirect lighting from the <em>next bounce. </em>Specifically, at each step we calculate the luminance of a direct bounce — aka utilizing our previous direct lighting function as if our current ray was the first. We also calculate indirect lighting by calculating the direct lighting for the next bounce and weigh it with the reflection equation. Finally, we choose to either <strong>accumulate all results </strong>or <strong>keep only the last bounce</strong>, according to user selection.</p><p id="e70ef6a1-5010-47c0-87ff-7f7f8853e6b2" class="">Below are some rendered examples of each option.</p><p id="14e60b08-e232-4e4f-accd-c86b26ac4c64" class="">Each command ran with settings <code>./pathtracer -t 8 -s 1024 -l 16 -m 0 -o 0 -r 480 360</code> on <code>/dae/sky/CBbunny.dae</code> .</p><p id="dbe0d417-8fb8-4aed-8473-ce98d6ee68f9" class="">
</p><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="75f3b54c-607a-41a9-aa0f-e34238adc7e8"><div style="font-size:1.5em"><span class="icon">🖇️</span></div><div style="width:100%"><strong>The following images can be found at </strong><code><strong>bunny_m{num_bounces}_o{isAccumBounces}.png</strong></code></div></figure><div id="800533a4-9d0e-4067-bf0b-1adbba542629" class="column-list"><div id="b886bf5b-7f4b-4213-a640-c7926f54f6dc" style="width:50%" class="column"><h3 id="0ccc8e3e-a5b1-473c-ab77-259bd51f1baf" class="">isAccumBounces = True (<code>-o 1</code>)</h3><figure id="7fc02e1b-56e1-4577-a459-b14d1cdfa17a" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m0_o0.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m0_o0.png"/></a><figcaption><code>-m 0</code>: 0 bounces</figcaption></figure><figure id="45027a4a-7e57-48c2-9611-731a6d581539" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m1_o1.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m1_o1.png"/></a><figcaption><code>-m 1</code>: 1 bounce</figcaption></figure><figure id="d4eb787a-a2ba-4250-a7a9-e8b48620002b" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m2_o1.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m2_o1.png"/></a><figcaption><code>-m 2</code>: 2 bounces</figcaption></figure><figure id="230bf7c4-d3bd-4508-99a9-6e36f00ddf0a" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m3_o1.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m3_o1.png"/></a><figcaption><code>-m 3</code>: 3 bounces</figcaption></figure><figure id="66691cc9-645f-4c51-af1c-ca72ae2d975a" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m4_o1.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m4_o1.png"/></a><figcaption><code>-m 4</code>: 4 bounces</figcaption></figure><figure id="81455280-5fbd-4865-ab1d-5a1d524a559f" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m5_o1.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m5_o1.png"/></a><figcaption><code>-m 5</code>: 5 bounces</figcaption></figure></div><div id="b7ab4f5c-be91-47dd-8615-ab1b479195ac" style="width:50%" class="column"><h3 id="cb42723a-c82a-497c-844e-d068e708caf6" class="">isAccumBounces = False (<code>-o 0</code>)</h3><figure id="3a8ba894-ef60-4f14-964f-68182a3ceb6a" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m0_o1.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m0_o1.png"/></a><figcaption><code>-m 0</code>: 0 bounces</figcaption></figure><figure id="3ff7cce5-97a6-46b6-a2e2-4b089ea3a031" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m1_o0.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m1_o0.png"/></a><figcaption><code>-m 1</code>: 1 bounce</figcaption></figure><figure id="05ffd47b-0906-4bd9-94ea-3c0923d549c6" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m2_o0.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m2_o0.png"/></a><figcaption><code>-m 2</code>: 2 bounces</figcaption></figure><figure id="817e1968-2158-4701-ad08-63e65abc1065" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m3_o0.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m3_o0.png"/></a><figcaption><code>-m 3</code>: 3 bounces</figcaption></figure><figure id="760fc3f8-4183-4674-8224-9587babf85a7" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m4_o0.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m4_o0.png"/></a><figcaption><code>-m 4</code>: 4 bounces</figcaption></figure><figure id="5669c69e-3987-4010-9a39-0b89998ff178" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m5_o0.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_m5_o0.png"/></a><figcaption><code>-m 5</code>: 5 bounces</figcaption></figure></div></div><div id="6ec8b05c-e3f0-47ab-a383-90101f06a866" class="column-list"><div id="930d9d6a-c6d1-49b3-8424-4fd4d88ac76b" style="width:50%" class="column"><h3 id="514548ac-6912-4274-a102-5dceec03e006" class="">Global? Indirect?</h3></div><div id="57667c52-90a0-43a7-947c-749049d09ca8" style="width:50%" class="column"><h3 id="f1381a83-8c00-4cac-b33b-903280ef1c07" class=""><strong>2nd Bounce? 3rd Bounce?</strong></h3></div></div><div id="942f0204-c10f-4257-8830-726b55432a88" class="column-list"><div id="cf42153b-0a36-45ff-83b3-cd4fffb8172a" style="width:50%" class="column"><p id="71c0660d-3020-44f4-813c-de441e62c462" class="">Now, the comparison between indirect vs global lighting becomes evident!</p><p id="749f02e9-4738-42e0-b908-1ef7a35e39ce" class="">We can see the global illumination accumulates both indirect and direct lighting. </p><p id="c74c3e12-f62c-461f-a1d9-bf400c2f634e" class="">Direct lighting dominates the bright areas of the image — understandably, as it goes through 0 extra bounces. However, indirect lighting provides weaker illumination to affected areas, such as the blurring of the shadows and the fur. Further note that indirect lighting transfers the <em>hit material</em>’s properties, according to their brdfs; thus, we see<strong> color blending</strong> from the walls in parts of the rabbit and shadow.</p><p id="ff84ffc0-d5f2-47e4-81cb-6636956a559f" class="">
</p></div><div id="eb9b891e-3f4d-4500-a665-b4d7f916145a" style="width:50%" class="column"><p id="447a204b-29e4-4cae-a79d-ec023fb237f6" class="">Notice how our indirect lighting is the same as our direct lighting, albeit without the overhead light, in the first two cases. </p><p id="10e6dca5-7c63-4c8c-a917-b98e61c9668f" class="">However, in two bounces and onwards, our indirect lighting results look different. On the second bounce, we see illumination in the bunny’s shadow and lower fur, thanks to light bouncing off the walls and reflecting onto the bunny. Also note the head of the bunny looks darker; this is reasonable because there are less “lit” areas that can hit the top of the bunny. Similarly, the third bounce reflects these findings similarly; the brightest spots from the previous bounce now reflect to the floors and corners, illuminating them. </p><p id="dce6ad98-f586-4c25-9da9-d8eebef89ce2" class="">Finally, note that the scene gets gradually darker; no matter the material, some energy is absorbed, leading to less reflected light as bounces increase.</p></div></div><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="217bb743-4291-4014-8a9d-25d84d9b9f99"><div style="font-size:1.5em"><span class="icon">💡</span></div><div style="width:100%"><strong>Direct lighting</strong> includes the parts of the scene <em>directly </em>touched by the light — thus, the bottoms of the spheres, shadows, etc. are entirely un-illuminated. On the other hand, the indirect lighting shows how the entire scene is illuminated due to light bouncing. This includes the blending on the sides of the spheres, as well as the reflected light in the shadow.<p id="7d3b86a1-774f-4758-95e9-532a8ee4edff" class="">The following images are rendered with the following command, manually varying the lighting returned.</p><p id="fb8447d8-404b-4457-95ef-217c20d899c4" class=""><code>./pathtracer -t 8 -s 1024 -m 5 -l 4 -r 480 360 ../dae/sky/CBspheres_lambertian.dae</code>  </p><div id="38daf018-663c-49fa-a637-e6cb5501a699" class="column-list"><div id="f1cae0fa-4521-4a22-93fc-433208ae7ab0" style="width:50%" class="column"><figure id="21ebb21b-68a7-4a18-9505-3ff7088c51cc" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/ball_direct.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/ball_direct.png"/></a><figcaption><strong>accumulated </strong>direct lighting only; <code>ball_direct.png</code></figcaption></figure></div><div id="c9b49798-7081-4045-bd5e-bbe844ba47a4" style="width:50%" class="column"><figure id="44dc977a-533c-4f29-9daa-d21c6dc32b6a" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/ball_indirect.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/ball_indirect.png"/></a><figcaption><strong>accumulated </strong>indirect lighting only; <code>ball_indirect.png</code></figcaption></figure></div></div><p id="cedcf783-9fb6-4f12-8ded-9a9abc66fca0" class="">Combining the above results, we get full global illumination.</p><figure id="4118fee0-7d1e-4e40-90b1-8275a2b4520d" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/ball_full_illum.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/ball_full_illum.png"/></a><figcaption>combined (full) illumination; note how there is a ring of “brightness” where indirect lighting is lighter. There is also the brightness from direct lighting. Finally, the harsh shadows in direct lighting are softened by indirect lighting with COLOR!!!<br/><br/><code>ball_full_illum.png</code></figcaption></figure></div></figure><h3 id="431871a3-c4ff-409d-ade0-2ae4cba82910" class="">Russian Roulette-ing</h3><p id="b7c2982c-c8c8-4ee6-8358-7252487b0150" class="">However, note that our simulation are always limited by lower #bounces; furthermore, it is wasteful to use a large # of bounces for every pixel. We can prevent this by introducing randomness into our system through Russian Roulette sampling — at each point with <code>bounces_left &gt; 1</code>, we randomly decide if we wish to terminate. This allows us to render images with a high # of bounces that remains unbiased.</p><p id="c1b47804-b2e7-4788-b8da-429387021746" class="">We use the following command to render the following, only varying the # of bounces (<code>-m</code>)</p><p id="47bdf714-4688-4fbd-aefe-9a9c120a601d" class=""><code>./pathtracer -t 8 -s 1024 -l 16 -r 480 360 ../dae/sky/CBbunny.dae</code></p><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="fef4d1e0-d468-4eeb-859f-929f65424a53"><div style="font-size:1.5em"><span class="icon">🖇️</span></div><div style="width:100%"><strong>The following images can be found at </strong><code><strong>bunny_rs_{num_bounces}.png</strong></code></div></figure><div id="db409ce2-6f7d-46d0-9e68-a1dda3964d18" class="column-list"><div id="7ddf8634-fca2-46f5-997d-ab90d1298324" style="width:50%" class="column"><figure id="0c5fb672-e5fe-40ac-809e-b15febe4fbb5" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_0.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_0.png"/></a><figcaption><code>-m = 0</code></figcaption></figure></div><div id="55796fe0-9759-45f6-b7b0-fabd6d1fb4aa" style="width:50%" class="column"><figure id="174e6cd7-2d78-4370-973b-c5db1e443a6a" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_1.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_1.png"/></a><figcaption><code>-m = 1</code></figcaption></figure></div></div><div id="77daa8cd-bf37-46cf-af5f-2393c9e5604c" class="column-list"><div id="df28d8d4-77e1-4bc4-a4fb-fee00fc81bdb" style="width:50%" class="column"><figure id="eb4d6183-9d7f-4f49-a70c-7a3c8140e80e" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_2.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_2.png"/></a><figcaption><code>-m = 2</code></figcaption></figure></div><div id="bffe34ac-ac1c-43ec-86cb-66ab18898bef" style="width:50%" class="column"><figure id="abddc8e0-3987-43a1-b0fb-6c2907f5e380" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_3.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_3.png"/></a><figcaption><code>-m = 3</code></figcaption></figure></div></div><div id="e8942033-c9cb-45e1-a6ed-f22ea6a04432" class="column-list"><div id="4797b9dd-d4b5-428b-ad17-c6df55e7e245" style="width:50%" class="column"><figure id="3a189f71-4fc2-4542-b064-24eca105e4e7" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_4.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_4.png"/></a><figcaption><code>-m = 4</code></figcaption></figure></div><div id="267a2735-4d2a-44d5-960d-49cd2f12c937" style="width:50%" class="column"><figure id="af4855df-c1f2-489c-953e-c3465767cc32" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_100.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rs_100.png"/></a><figcaption><code>-m = 100</code></figcaption></figure></div></div><p id="c25cac0d-e9cf-4310-bb04-c9a657323069" class="">Note how the result seem to converge by <code>m = 3</code>, even though we allow bounces up to 100!</p><p id="daec24e9-b4a8-4252-8c4d-83210535edef" class="">
</p><p id="cfb76103-5c44-4d8c-b78f-20ae4d961854" class="">Finally, we show the effects of samples per pixel on render.</p><p id="1eabf075-ed8b-4a2d-94f2-31b698251d29" class="">The below are all run with the following command, only varying samples per pixel (<code>-s</code>)</p><p id="b873578e-3d5b-4902-8344-70c74109ee21" class=""><code>./pathtracer -t 8 -l 4 -m 5 -r 480 360 ../dae/sky/CBspheres_lambertian.dae</code>  </p><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="4bf6b1cb-5384-4bf7-87a7-4a0a870bcbb6"><div style="font-size:1.5em"><span class="icon">🖇️</span></div><div style="width:100%"><strong>The following images can be found at </strong><code><strong>spheres_spp_{sample_rate}.png</strong></code></div></figure><div id="760f92f0-1fcb-4217-af2f-88d27d826cf2" class="column-list"><div id="6f8810dd-7e20-4797-ba24-320b88662866" style="width:50%" class="column"><figure id="47cc4968-585b-4bec-b4f9-a9ffcfe506c5" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_1.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_1.png"/></a><figcaption><code>-s 1 </code> : 1 sample per pixel</figcaption></figure></div><div id="c57e8d93-0f4c-45e6-adc5-855e904b8318" style="width:50%" class="column"><figure id="61e11f5f-028f-4465-9696-b65aeea6311a" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_2.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_2.png"/></a><figcaption><code>-s 2 </code> : 2 samples per pixel</figcaption></figure></div></div><div id="bf838d26-4751-43a6-8989-ca675b1e0c69" class="column-list"><div id="b10d657d-2033-4842-b2ce-d9369b7aabdd" style="width:50%" class="column"><figure id="6402333b-30ae-4a58-b458-799a03352b91" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_4.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_4.png"/></a><figcaption><code>-s 4 </code> : 4 samples per pixel</figcaption></figure></div><div id="286172d3-cc4e-46c2-8b3a-048b2ea53fff" style="width:50%" class="column"><figure id="43a5a5b2-f5b3-4103-9f4a-7ac088a1e792" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_8.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_8.png"/></a><figcaption><code>-s 8 </code> : 8 samples per pixel</figcaption></figure></div></div><div id="2d934a79-0018-47e0-b96b-47cb55834334" class="column-list"><div id="1ee28013-c0a7-4737-9c1a-e756a86ea5b6" style="width:50%" class="column"><figure id="3e519ad2-4e73-43ca-a6cf-65d5d1e190a8" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_16.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_16.png"/></a><figcaption><code>-s 16 </code> : 16 samples per pixel</figcaption></figure></div><div id="8ae06e8c-fa4b-486b-bfb1-144c7e598bf9" style="width:50%" class="column"><figure id="fbee4ef6-b448-41d9-bb2a-48280b91e52b" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_64.png"><img style="width:331px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_64.png"/></a><figcaption><code>-s 64 </code> : 64 samples per pixel</figcaption></figure></div></div><figure id="3ca3865d-dfa1-4b36-b4b1-224d04686015" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_1024.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/spheres_spp_1024.png"/></a><figcaption><code>-s 1024</code>  : 1024 samples per pixel</figcaption></figure><p id="01ab0127-0e5a-4c35-b35c-6d9424665a52" class="">It is visible that higher sample rates decrease noise; this makes sense as the pixel color is now an average over multiple rays, and not the result of a singular ray. It is also noticeable that, at lower sampling rates, there are more extreme colors such as pure blacks or whites. However, the average brightness of the scene remains consistent. This is because those outlier values are not averaged out, as they would be with higher sampling rates, leading to jagginess.</p><h2 id="98304dff-75de-40a1-a9f9-d422c1c48c22" class=""><strong>Part 5: Adaptive Sampling</strong></h2><p id="f8d954be-e8f9-498f-a6d7-62908e31f215" class="">Finally, we implement adaptive sampling. We reiterate on the idea that it is wasteful to sample too much on areas without much change by dynamically adjusting our sampling rate.<br/>In our implementation, we decide to stop when our samples so far converge with 96% confidence — we calculate this by keeping a running sum of values, and check for convergence every <br/><code>samplesPerBatch</code> pixels. If convergence is satisfied, we end early; else, we keep going. It’s important to note that we now scale by the total # of pixels <em>actually</em> sampled, not the max # we <em>can </em>sample.</p><p id="d0afd9af-b102-4f2d-b4d0-38f092cc5b6b" class="">Shown below are examples of adaptive sampling; blue means low sampling rates, while red means high sampling rates. </p><p id="69cdf190-a899-4fe6-b89e-50c71baf4351" class="">Settings: <code>./pathtracer -t 8 -s 2048 -a 64 0.05 -l 1 -m 5 -r 480 360</code></p><div id="d933f354-17fb-499b-908b-1c6b31b6a4c1" class="column-list"><div id="9c0fa17d-1ff5-4eae-8356-800461cfaeb0" style="width:50%" class="column"><figure id="d8f636eb-7af0-4be5-9027-00f40230724b" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny.png"/></a><figcaption><code>bunny_adaptive.png</code></figcaption></figure></div><div id="db24a5f2-eec8-4ab4-85e4-d06c1e10a39f" style="width:50%" class="column"><figure id="0b96c760-8692-472a-b332-8e8e03b18d3a" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rate.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/bunny_rate.png"/></a><figcaption><code>bunny_adaptive_rate.png</code></figcaption></figure></div></div><p id="a988e0c5-9ab1-40e5-bb4e-3100e5d597fb" class="">Evidently, areas with change — the rabbits fur, the shadow — are sampled more than the plain walls.</p><div id="c21dd131-c80b-4d46-97da-9b0d9973b41a" class="column-list"><div id="d79efefc-d16e-464c-89f5-b2f810749ef9" style="width:50%" class="column"><figure id="18d59e2e-f64f-44a1-a38e-d1dc5bc258b3" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/not_bunny.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/not_bunny.png"/></a><figcaption><code>not_bunny_adaptive.png</code></figcaption></figure></div><div id="8a8ef10f-ab62-4f75-93d0-d4608fec96bc" style="width:50%" class="column"><figure id="c926ca67-df42-40ea-8800-1c691c1778bd" class="image"><a href="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/not_bunny_rate.png"><img style="width:480px" src="CS184%20Ray-tracing%20870d1e1f7aaf4fb0ad2182100adbddda/not_bunny_rate.png"/></a><figcaption><code>not_bunny_adaptive_rate.png</code></figcaption></figure></div></div><p id="705fdf11-405e-4e0c-9753-96399d4cc30b" class="">Similarly, we see higher sampling rates in the textures of the dragon’s scales and fins. On the other hand, the smooth platform it sits on has little change and is sampled at a low rate.</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>